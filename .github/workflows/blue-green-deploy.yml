name: Blue-Green Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-to-green:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Debug - Show current directory
      run: pwd && ls -la
    
    - name: Debug - Check if source files exist
      run: |
        echo "Checking source files:"
        ls -la src/ || echo "No src directory"
        ls -la lib/ || echo "No lib directory"
    
    - name: Build application
      run: |
        mkdir -p target/classes
        javac -cp "lib/*" -d target/classes src/*.java
        echo "✅ Build completado"
    
    - name: Create railway config
      run: |
        echo '[build]' > railway.toml
        echo 'builder = "nixpacks"' >> railway.toml
        echo '' >> railway.toml
        echo '[deploy]' >> railway.toml
        echo 'numReplicas = 1' >> railway.toml
        cat railway.toml
    
    - name: Install Railway CLI
      run: npm install -g @railway/cli
    
    - name: Debug - Check Railway CLI installation
      run: railway --version
    
    - name: Deploy to Green Project
      run: railway deploy --detach
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_GREEN }}

  deploy-to-blue:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Build application
      run: |
        mkdir -p target/classes
        javac -cp "lib/*" -d target/classes src/*.java
        echo "✅ Build completado"
    
    - name: Create railway config
      run: |
        echo '[build]' > railway.toml
        echo 'builder = "nixpacks"' >> railway.toml
        echo '' >> railway.toml
        echo '[deploy]' >> railway.toml
        echo 'numReplicas = 1' >> railway.toml
    
    - name: Install Railway CLI
      run: npm install -g @railway/cli
    
    - name: Deploy to Blue Project
      run: railway deploy --detach
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_BLUE }}